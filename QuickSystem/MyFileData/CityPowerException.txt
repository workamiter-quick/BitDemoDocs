
---------------------------------------------------

SELECT
    col.name, col.collation_name
FROM 
    sys.columns col
WHERE
    object_id = OBJECT_ID('FlatTable_ST_POI_2')


	ALTER TABLE FlatTable_ST_POI_2
  ALTER COLUMN POI_DeviceID
    VARCHAR(100) COLLATE SQL_Latin1_General_CP1_CI_AS NOT NULL
    
    
    Cannot resolve the collation conflict between "Latin1_General_CI_AS" and "SQL_Latin1_General_CP1_CI_AS" in the equal to operation.
    --------------------------------------------
    
    -----ALTER TABLE Pin_DesktopReviewMain ADD TID int identity(1,1)
    -----ALTER TABLE Pin_DesktopReviewMain DROP  COLUMN TID ;  
    
    ---------------------------------------------


update SUPRIMA_Consumer
set consumer_address_3 = ISNULL(consumer_address_3,'')
ogr2ogr -f "ESRI Shapefile" "H:\ProjDesc\CityPower\Midrand\Valuation_Property_Midrand_12385.shp" "MSSQL:server=DWJHB\MSSQLSERVER2014; database=CITY_POWER_GIS;uid=sa;pwd=java" -sql "select PIN, LegalDescr, SearchAddr as Address, RatingCate, UseCode, Extent, MarketValu, Ownership, AccountNum, SG_ID, Depot_Name, Region, STAND_NO, Geom.STAsBinary() as geom from Midrand_Valuation_Property_300_16124 where Suprima_UID is null and MRQC_AccountNumber_GID = 0" //Midrand
ogr2ogr -f "ESRI Shapefile" "H:\ProjDesc\CityPower\$DataAnalysis\MidrandShapeFiles\SIEMERT.shp" "MSSQL:server=DWJHB\MSSQLSERVER2014; database=CITY_POWER_GIS;uid=sa;pwd=java" -sql "select PIN, LegalDescription, SearchAddress as Address, RatingCategory, UseCode, Extent, MarketValue, Ownership, AccountNumber, SG_ID, Depot_Name, Region, STAND_NO, Geom.STAsBinary() as geom, UseDescription, IsMatched as MatchedCode from SIEMERT_Valuation_Property"

select top 100 * from Valuation where AccountNumber = '990000164'
select top 100 * from SalesInventory

select top 100 * from CityPower_COJ_Public.dbo.SalesFromCityPower where [Contract Account] = '990000164'


not valution

not lis



select count(*) from Valuation a inner join LIS_Properties b on a.PIN = b.PIN
select count(*) from Valuation
select count(*) from LIS_Properties where PIN is null



GIS Data filter in citypower boundary
filter between billable and non billable data


  update CITY_POWER_GIS.dbo.PropertyMasterTable
  set FlagMRQC = 1  from CITY_POWER_GIS.dbo.PropertyMasterTable a inner join CITY_POWER_GIS.dbo.SalesFromCityPower_Jan2018 b
  on a.AccountNumber = b.AccountNumber



select a.PIN, b.AccountNumber,b.LegalDescription, b.SearchAddress as Address, '' as CustomerName, '' as ContactNumber, b.RatingCategory, b.MarketValue, b.Extent, b.UseCode, a.RegionID, a.DEPOT_NAME, '' as PostPaidBillingType, '' as PrePaidBillingType, 0 as FlagMRCQ, 0 as FlagSuprima, a.CGeom.STX as X, a.CGeom.STY as Y, a.CGeom as CenterGeom, a.Geom into PropertyMasterTable  from LIS_Properties a inner join Valuation b on a.PIN = b.PIN where a.IsEskomOrDepot = 'C'



select distinct ct from (select [Contract Account] as ct from SalesFromCityPower_Jan2018
where [Contract Account] in (select AccountNumber from CITY_POWER_GIS.dbo.PropertyMasterTable where DEPOT_NAME = 'midrand')) as d


select count(*) from CITY_POWER_GIS.dbo.PropertyMasterTable where FlagMRQC = 1 --DEPOT_NAME = 'midrand'

select count(*) from SalesFromCityPower_Jan2018
  update CITY_POWER_GIS.dbo.PropertyMasterTable
  set FlagSalseFiles_Jan2018 = 1  
  
  drop table __LL
 select distinct ct into __LL from (select b.[Contract Account] as ct from CITY_POWER_GIS.dbo.PropertyMasterTable a inner join CITY_POWER_GIS.dbo.SalesFromCityPower_Dec2017 b
  on a.AccountNumber = b.[Contract Account]) as d

 select count(*) from CITY_POWER_GIS.dbo.PropertyMasterTable where FlagSalseFiles_Jan2018 = 0

 update CITY_POWER_GIS.dbo.PropertyMasterTable
  set FlagSalseFiles_Dec2017 = 1   from CITY_POWER_GIS.dbo.PropertyMasterTable a inner join CITY_POWER_GIS.dbo.__LL b
  on a.AccountNumber = b.CT


 

select count(*) from SalesFromCityPower_Jan2018
select count(*) from SalesFromCityPower_Dec2017


select top 5 * from PropertyMasterTable
  select top 5 * from SalesFromCityPower_Jan2018
   select top 5 * from SalesFromCityPower_Dec2017

  select count(*) from (select distinct [Contract Account] from SalesFromCityPower_Jan2018) as a
  select count(*) from (select distinct [Contract Account] from SalesFromCityPower_Dec2017) as a


update PropertyMasterTable set  STAND_NO = '0' where STAND_NO is null


    
    
    
    select count(*) from PropertyMasterTable_2 where IsEskomOrCityPower = 'C' and AccountNumber = '0' 
    
select count(*) from PropertyMasterTable_2 where Depot_name = 'midrand' and IsEskomOrCityPower = 'C' and AccountNumber = '0' 


select distinct account_no from CITY_POWER_MRQC.dbo.MRQC_MASTER_TABLE where LTRIM(RTRIM(account_no)) in (select AccountNumber from PropertyMasterTable_2 where Depot_name = 'midrand' and IsEskomOrCityPower = 'C')
select distinct property_id from CITY_POWER_MRQC.dbo.MRQC_MASTER_TABLE where LTRIM(RTRIM(property_id)) in (select PropertyID from PropertyMasterTable_2 where Depot_name = 'midrand' and IsEskomOrCityPower = 'C')
select distinct [Contract Account] from SalesFromCityPower_Jan2018 where LTRIM(RTRIM([Contract Account])) in (select AccountNumber from PropertyMasterTable_2 where Depot_name = 'midrand' and IsEskomOrCityPower = 'C')
--------------------------------------------------------------------------------------
select Distinct AccountNumber as AccountNumber into __CompanyCode_Acc from PropertyMasterTable_2 where Depot_name = 'midrand' and IsEskomOrCityPower = 'C'
  
 SELECT * from  [dbo].[__CompanyCode_Acc]

 ALTER TABLE __CompanyCode_Acc ADD Rates int
ALTER TABLE __CompanyCode_Acc ADD Water int
ALTER TABLE __CompanyCode_Acc ADD City_Power int
ALTER TABLE __CompanyCode_Acc ADD Sewer int
ALTER TABLE __CompanyCode_Acc ADD Refuse int
 drop table __CompanyCode_Acc
 drop table __Dec2017

 SalesFromCityPower_Dec2017
 SalesFromCityPower_Jan2018

 select a.[Contract Account] as Acc, a.[Company Code] as CC into __Dec2017 from SalesFromCityPower_Dec2017 a inner join __CompanyCode_Acc b on b.AccountNumber = a.[Contract Account] order by a.[Contract Account]

select Rates, count(Rates) from __CompanyCode_Acc group by Rates
select Water, count(Water) from __CompanyCode_Acc group by Water
select City_Power, count(City_Power) from __CompanyCode_Acc group by City_Power
select Sewer, count(Sewer) from __CompanyCode_Acc group by Sewer
select Refuse, count(Refuse) from __CompanyCode_Acc group by Refuse

update __CompanyCode_Acc set Rates = 0
update __CompanyCode_Acc set Water = 0
update __CompanyCode_Acc set City_Power = 0
update __CompanyCode_Acc set Sewer = 0
update __CompanyCode_Acc set Refuse = 0


update __CompanyCode_Acc set Rates = 1 from __CompanyCode_Acc a inner join __Dec2017  b on a.AccountNumber = b.Acc where b.CC = '100'
update __CompanyCode_Acc set Water = 1 from __CompanyCode_Acc a inner join __Dec2017  b on a.AccountNumber = b.Acc where b.CC = '200'
update __CompanyCode_Acc set City_Power = 1 from __CompanyCode_Acc a inner join __Dec2017  b on a.AccountNumber = b.Acc where b.CC = '300'
update __CompanyCode_Acc set Sewer = 1 from __CompanyCode_Acc a inner join __Dec2017  b on a.AccountNumber = b.Acc where b.CC = '400'
update __CompanyCode_Acc set Refuse = 1 from __CompanyCode_Acc a inner join __Dec2017  b on a.AccountNumber = b.Acc where b.CC = '500'



--------------------------------------------------------------------------------------------

get count of property record

select ISNULL(SG_ID, '') as [Property ID or SGID],PIN,ISNULL(Stand_No, '') as [Stand No],GID as [LISGIS ID],AccountNum as [Account No],LegalDescr as [Legal Description],StreetAddr as [Address],RatingCate as [Rating Category],UseCode as [Use Code],cast(MarketValu As float) as [Market Value],cast(Extent As float) as Extent, 	cast(XCoord as nvarchar(255)) + ', ' + cast(YCoord as nvarchar(255)) as [X,Y], 'C' as [Is Eskom or City Power], Region as [Region ID],Depot_Code as [Depot Code],	Depot_Name as [Depot Name] from __CP.dbo.Valuation_Property_Midrand_95 order by MarketValu desc



select top 100 * from __Suprima_Prepaid_Master_Data_Master

select top 100 * from Valuation where IsEskomOrCityPower = 'C'

select top 100 * from Valuation where Stand_NO in (select [Stand No 2] from __Suprima_Prepaid_Master_Data_Master)


select * into __Valuation__Suprima_ON_STAND_NO from Valuation a inner join  __Suprima_Prepaid_Master_Data_Master b on a.STAND_NO = b.[Stand No 2]






Update __MRQC_Meter7
set IsDuplicate = 1
where meter_id not in (
select max(meter_id)  from __MRQC_Meter7
group by UniqueID having count(*) > 1 )


select * from (select AccountNumber, count(AccountNumber) as c from __MappingBetweenAccountNumberAndMeter group by AccountNumber) as weqew order by c




select
'City Power Area' as Caption,
(Select count(*) from Valuation_CityPower) as [Total Property],
(Select count(*) from Valuation_CityPower where AccountNumber = '') as [Account Number is blank],
(Select count(*) from Valuation_CityPower where Suprima_UID != 0) as [Suprima Matching],
(Select count(*) from Valuation_CityPower where MRQC_AccountNumber_GID != 0) as [MRQC Account Number Matching]

union all

select
'Midrand' as Caption,
(Select count(*) from Valuation_CityPower where Depot_Name = 'MIDRAND') as [Total Property],
(Select count(*) from Valuation_CityPower where AccountNumber = '' and Depot_Name = 'MIDRAND') as [Account Number is blank],
(Select count(*) from Valuation_CityPower where Suprima_UID != 0 and Depot_Name = 'MIDRAND') as [Suprima Matching],
(Select count(*) from Valuation_CityPower where MRQC_AccountNumber_GID != 0 and Depot_Name = 'MIDRAND') as [MRQC Account Number Matching]

union all

select
'ALEXANDRA' as Caption,
(Select count(*) from Valuation_CityPower where Depot_Name = 'ALEXANDRA') as [Total Property],
(Select count(*) from Valuation_CityPower where AccountNumber = '' and Depot_Name = 'ALEXANDRA') as [Account Number is blank],
(Select count(*) from Valuation_CityPower where Suprima_UID != 0 and Depot_Name = 'ALEXANDRA') as [Suprima Matching],
(Select count(*) from Valuation_CityPower where MRQC_AccountNumber_GID != 0 and Depot_Name = 'ALEXANDRA') as [MRQC Account Number Matching]

union all

select
'HURSTHILL' as Caption,
(Select count(*) from Valuation_CityPower where Depot_Name = 'HURSTHILL') as [Total Property],
(Select count(*) from Valuation_CityPower where AccountNumber = '' and Depot_Name = 'HURSTHILL') as [Account Number is blank],
(Select count(*) from Valuation_CityPower where Suprima_UID != 0 and Depot_Name = 'HURSTHILL') as [Suprima Matching],
(Select count(*) from Valuation_CityPower where MRQC_AccountNumber_GID != 0 and Depot_Name = 'HURSTHILL') as [MRQC Account Number Matching]

union all

select
'LENASIA' as Caption,
(Select count(*) from Valuation_CityPower where Depot_Name = 'LENASIA') as [Total Property],
(Select count(*) from Valuation_CityPower where AccountNumber = '' and Depot_Name = 'LENASIA') as [Account Number is blank],
(Select count(*) from Valuation_CityPower where Suprima_UID != 0 and Depot_Name = 'LENASIA') as [Suprima Matching],
(Select count(*) from Valuation_CityPower where MRQC_AccountNumber_GID != 0 and Depot_Name = 'LENASIA') as [MRQC Account Number Matching]

union all

select
'RANDBURG' as Caption,
(Select count(*) from Valuation_CityPower where Depot_Name = 'RANDBURG') as [Total Property],
(Select count(*) from Valuation_CityPower where AccountNumber = '' and Depot_Name = 'RANDBURG') as [Account Number is blank],
(Select count(*) from Valuation_CityPower where Suprima_UID != 0 and Depot_Name = 'RANDBURG') as [Suprima Matching],
(Select count(*) from Valuation_CityPower where MRQC_AccountNumber_GID != 0 and Depot_Name = 'RANDBURG') as [MRQC Account Number Matching]

union all

select
'REUVEN' as Caption,
(Select count(*) from Valuation_CityPower where Depot_Name = 'REUVEN') as [Total Property],
(Select count(*) from Valuation_CityPower where AccountNumber = '' and Depot_Name = 'REUVEN') as [Account Number is blank],
(Select count(*) from Valuation_CityPower where Suprima_UID != 0 and Depot_Name = 'REUVEN') as [Suprima Matching],
(Select count(*) from Valuation_CityPower where MRQC_AccountNumber_GID != 0 and Depot_Name = 'REUVEN') as [MRQC Account Number Matching]

union all

select
'ROODEPOORT' as Caption,
(Select count(*) from Valuation_CityPower where Depot_Name = 'ROODEPOORT') as [Total Property],
(Select count(*) from Valuation_CityPower where AccountNumber = '' and Depot_Name = 'ROODEPOORT') as [Account Number is blank],
(Select count(*) from Valuation_CityPower where Suprima_UID != 0 and Depot_Name = 'ROODEPOORT') as [Suprima Matching],
(Select count(*) from Valuation_CityPower where MRQC_AccountNumber_GID != 0 and Depot_Name = 'ROODEPOORT') as [MRQC Account Number Matching]

union all

select
'SIEMERT' as Caption,
(Select count(*) from Valuation_CityPower where Depot_Name = 'SIEMERT') as [Total Property],
(Select count(*) from Valuation_CityPower where AccountNumber = '' and Depot_Name = 'SIEMERT') as [Account Number is blank],
(Select count(*) from Valuation_CityPower where Suprima_UID != 0 and Depot_Name = 'SIEMERT') as [Suprima Matching],
(Select count(*) from Valuation_CityPower where MRQC_AccountNumber_GID != 0 and Depot_Name = 'SIEMERT') as [MRQC Account Number Matching]










select * from (select AccountNumber, count(AccountNumber) as RecordCount from __MappingBetweenAccountNumberAndMeter group by AccountNumber) as weqew order by RecordCount desc




-----------------------------------------------------Summary-----------------------------------
1408 COJ Account NUmber (1634)
1118 Records on basis of GPS_Co_Ordinates(which is like SG_ID)  and SG_ID
769 Records on basis of STAND No 2  and STAND_NO
29 Record got on the Basis of First Name + Surename and Ownership (12 old Matchs)
95 matching using Google Geocode(House No,Street,City,District in Suprima)(477 old batch)



14716
1408

13598
2526

12829
3295

12705
3419

728 record both in Suprima and MRQC

1048 in MRQC(320)

3739 total Match Suprima and MRQC(12385)


-----------------------------------------------------------------------------------------------------


Some Query -----------------------
select * from Valuation_CityPower  WHERE Suprima_UID != 0

select Depot_Name, count(Depot_Name) from Valuation_CityPower group by Depot_Name

select * from LENASIA_Valuation_Property where Suprima_UID != 0 order by Suprima_UID desc, MRQC_AccountNumber_GID desc

update LENASIA_Valuation_Property
set Suprima_UID = 0, MRQC_AccountNumber_GID = 0

select * from LENASIA_Valuation_Property a inner join __COJ_AccNum_SUPRIMA_Prepaid_Master_Data_Master b
on a.AccountNumber = b.AccNum

update LENASIA_Valuation_Property
set Suprima_UID = b.UID from LENASIA_Valuation_Property a inner join __COJ_AccNum_SUPRIMA_Prepaid_Master_Data_Master b
on a.AccountNumber = b.AccNum

update LENASIA_Valuation_Property
set  MRQC_AccountNumber_GID = b.GID from LENASIA_Valuation_Property a inner join MRQC_Account b
on a.AccountNumber = b.AccountNumber where b.AccountNumber != ''


select * from LENASIA_Valuation_Property a inner join MRQC_Account b
on a.AccountNumber = b.AccountNumber where b.AccountNumber != ''

select ISNULL(SG_ID, '') as [Property ID or SGID],PIN,ISNULL(Stand_No, '') as [Stand No],AccountNumber as [Account No],LegalDescription as [Legal Description],StreetAddress as [Address],RatingCategory as [Rating Category],UseCode as [Use Code],cast(MarketValue As float) as [Market Value],cast(Extent As float) as Extent, 	cast(XCoord as nvarchar(255)) + ', ' + cast(YCoord as nvarchar(255)) as [X,Y], 'C' as [Is Eskom or City Power], Region as [Region ID],Depot_Code as [Depot Code],	Depot_Name as [Depot Name] from LENASIA_Valuation_Property b where Suprima_UID != 0 order by MarketValue desc
select ISNULL(SG_ID, '') as [Property ID or SGID],PIN,ISNULL(Stand_No, '') as [Stand No],AccountNumber as [Account No],LegalDescription as [Legal Description],StreetAddress as [Address],RatingCategory as [Rating Category],UseCode as [Use Code],cast(MarketValue As float) as [Market Value],cast(Extent As float) as Extent, 	cast(XCoord as nvarchar(255)) + ', ' + cast(YCoord as nvarchar(255)) as [X,Y], 'C' as [Is Eskom or City Power], Region as [Region ID],Depot_Code as [Depot Code],	Depot_Name as [Depot Name] from LENASIA_Valuation_Property b where MRQC_AccountNumber_GID != 0 order by MarketValue desc

select count(*) from (select distinct([Contract Account]) as AccNum from SalesFromCityPower_Dec2017) as d
inner join LENASIA_Valuation_Property b
on d.AccNum = b.AccountNumber

select count(*) from (select distinct([Contract Account]) as AccNum from SalesFromCityPower_Jan2018) as d
inner join LENASIA_Valuation_Property b
on d.AccNum = b.AccountNumber

select count(*) from (select distinct([Contract Account]) as AccNum from SalesFromCityPower_Feb2018) as d
inner join LENASIA_Valuation_Property b
on d.AccNum = b.AccountNumber


select count(*) from (select distinct([Contract Account]) as AccNum from SalesFromCityPower_March2018) as d
inner join LENASIA_Valuation_Property b
on d.AccNum = b.AccountNumber


select count(*) from (select distinct([Contract Account]) as AccNum from SalesFromCityPower_Dec2017 where [Company Code] = '300') as d
inner join LENASIA_Valuation_Property b
on d.AccNum = b.AccountNumber

select count(*) from (select distinct([Contract Account]) as AccNum from SalesFromCityPower_Jan2018 where [Company Code] = '300') as d
inner join LENASIA_Valuation_Property b
on d.AccNum = b.AccountNumber

select count(*) from (select distinct([Contract Account]) as AccNum from SalesFromCityPower_Feb2018 where [Company Code] = '300') as d
inner join LENASIA_Valuation_Property b
on d.AccNum = b.AccountNumber

select count(*) from (select distinct([Contract Account]) as AccNum from SalesFromCityPower_March2018 where [Company Code] = '300') as d
inner join LENASIA_Valuation_Property b
on d.AccNum = b.AccountNumber



---------------------------------------------




select * from Valuation where AccountNumber = '552629528'

select  [COJ ACC NO], [Meter No], [SAP No], B from SUPRIMA_Prepaid_Master_Data_Master where [COJ ACC NO] in (select Acc from (select Acc, count(Acc) as cnt from (select [COJ ACC NO] as Acc from SUPRIMA_Prepaid_Master_Data_Master where LTRIM(RTRIM([COJ ACC NO])) != '') as f group by Acc) as w where cnt = 15) order by  [COJ ACC NO] desc

select * from (select SG_ID, count(SG_ID) as c from Midrand_Valuation_Property_12385 group by SG_ID) as sxadsa where c > 1




select a.LegalDescr, a.StreetAddr, a.RatingCate, a.Ownership,a.SG_ID,
b.SG_ID,b.AccountNumber,a.AccountNum,b.[Is Sectional Title Parent Property],b.Elec_Div_1_Inst,b.Elec_Div_8_Inst 
from CITY_POWER_GIS.dbo.Midrand_Valuation_Property a inner join 
CITY_POWER_RATE_MRQC.dbo.All_Registered_Properties_20180331 b
--on a.SG_ID = b.SG_ID 
on a.AccountNum = b.AccountNumber 
where a.SG_ID != '' and a.AccountNum != '' 
--and b.[Is Sectional Title Parent Property] = 'Y'
order by b.SG_ID


20968, 20715
12385, 12285
16124, 15985
4749, 4691
95, 39


select * from CITY_POWER_GIS.dbo.Midrand_Valuation_Property where AccountNum not in (select a.AccountNum
from CITY_POWER_GIS.dbo.Midrand_Valuation_Property a inner join 
CITY_POWER_RATE_MRQC.dbo.All_Registered_Properties_20180331 b
on a.AccountNum = b.AccountNumber 
where a.SG_ID != '' and a.AccountNum != '' ) and AccountNum != '' and RatingCate = 'Residential' order by RatingCate



select top 5 * from CITY_POWER_RATE_MRQC.dbo.All_Registered_Properties_20180331  a
inner Join (select top 5 RTRIM(LTRIM([First Name])) + ' ' + RTRIM(LTRIM([Surname])) as Name from CITY_POWER_GIS.dbo.SUPRIMA_Prepaid_Master_Data_Master)  b
on a.LIS_Owner_Name = b.Name where a.LIS_Owner_Name != ''
-------------------------------------------------------------------------------------------------------------------------------------
sanridge : 900833580
West end: 555051965, 554493978
HOGH1 : 901003721, 901182451


declare @g geometry
select @g=geom from Valuation2 where DEPOT_NAME = 'MIDRAND' and AccountNumber = '555051965'
--select @g
select * from Valuation2 where @g.STIntersects(geom_center) = 1


select count(*) from __Midrand_Valuation2 a INNER JOIN CITY_POWER_RATE_MRQC.dbo.All_Registered_Properties_20180331 b 
on a.SG_ID  = LTRIM(RTRIM(b.SG_ID)) 


4 for Midrand


update Midrand_Valuation2
set IsMatched = 1
 from Midrand_Valuation2 a inner join __Midrand_Valuation_Main_AccNum b on a.UniqueID = b.UniqueID
 
 
 select * from (select IsMatched, count(IsMatched) as count from Midrand_Valuation_Property_Without_ST  group by IsMatched) as d order by IsMatched
 
 
 
   select * from Midrand_Valuation2 a
   inner join
   (SELECT distinct [Contract Account]
 FROM [CITY_POWER_MIDRAND].[dbo].SalesFromCityPower_Jan2018
 where [Company Code] = '300' and [Rate Category] = 'E_B_RESELN' or [Rate Category] = 'EL_R_RESEL'
  ) as d
  on a.AccountNumber = d.[Contract Account]
 where a.Depot_Name = 'MIDRAND'
 
 
 select * from Midrand_Valuation2
 where SG_ID in 
  (select distinct [SG Id] from YDM_Dec_2017 a
   inner join
   (SELECT distinct AccountNumber
 FROM [CITY_POWER_MIDRAND].[dbo].SalesFromCityPower_Jan2018
 where [Company Code] = '300' and [Rate Category] = 'E_B_RESELN' or [Rate Category] = 'EL_R_RESEL'
  ) as d
 on a.[Contract Account] = d.AccountNumber)
 
 
 select ISNULL(a.SG_ID, '') as [Property ID or SGID],PIN,ISNULL(Stand_No, '') as [Stand No],AccountNum as [Account No],LegalDescr as [Legal Description],StreetAddr as [Address],RatingCate as [Rating Category],a.UseCode as [Use Code],cast(MarketValu As float) as [Market Value],cast(Extent As float) as Extent, 	cast(XCoord as nvarchar(255)) + ', ' + cast(a.YCoord as nvarchar(255)) as [X,Y], 'C' as [Is Eskom or City Power], a.Region as [Region ID],a.Depot_Code as [Depot Code],	a.Depot_Name as [Depot Name], b.UseDescription from (select * from Midrand_Valuation_Property_Without_ST where ismatched not in (4, 0, 5)) a inner join UseCodeList b on a.UseCode = b.UseCode order by  a.SG_ID desc
select ISNULL(a.SG_ID, '') as [Property ID or SGID],PIN,ISNULL(Stand_No, '') as [Stand No],AccountNumber as [Account No],LegalDescription as [Legal Description],StreetAddress as [Address],RatingCategory as [Rating Category],a.UseCode as [Use Code],cast(MarketValue As float) as [Market Value],cast(Extent As float) as Extent, 	cast(XCoord as nvarchar(255)) + ', ' + cast(a.YCoord as nvarchar(255)) as [X,Y], 'C' as [Is Eskom or City Power], a.Region as [Region ID],a.Depot_Code as [Depot Code],	a.Depot_Name as [Depot Name], b.UseDescription from (select * from Midrand_Valuation2 where ismatched in (5)) a inner join UseCodeList b on a.UseCode = b.UseCode order by  a.SG_ID desc


select UseDescription, count(UseDescription) as Count from
(select ISNULL(a.SG_ID, '') as [Property ID or SGID],PIN,ISNULL(Stand_No, '') as [Stand No],AccountNum as [Account No],LegalDescr as [Legal Description],StreetAddr as [Address],RatingCate as [Rating Category],a.UseCode as [Use Code],cast(MarketValu As float) as [Market Value],cast(Extent As float) as Extent, 	cast(XCoord as nvarchar(255)) + ', ' + cast(a.YCoord as nvarchar(255)) as [X,Y], 'C' as [Is Eskom or City Power], a.Region as [Region ID],a.Depot_Code as [Depot Code],	a.Depot_Name as [Depot Name], b.UseDescription from (select * from Midrand_Valuation_Property_Without_ST where ismatched in (0)) a inner join UseCodeList b on a.UseCode = b.UseCode) as d group by UseDescription
order by Count desc



select [Rating Category], count([Rating Category]) as Count from
(select ISNULL(a.SG_ID, '') as [Property ID or SGID],PIN,ISNULL(Stand_No, '') as [Stand No],AccountNumber as [Account No],LegalDescription as [Legal Description],StreetAddress as [Address],RatingCategory as [Rating Category],a.UseCode as [Use Code],cast(MarketValue As float) as [Market Value],cast(Extent As float) as Extent, 	cast(XCoord as nvarchar(255)) + ', ' + cast(a.YCoord as nvarchar(255)) as [X,Y], 'C' as [Is Eskom or City Power], a.Region as [Region ID],a.Depot_Code as [Depot Code],	a.Depot_Name as [Depot Name], b.UseDescription from (select * from Midrand_Valuation2 where ismatched in (0)) a inner join UseCodeList b on a.UseCode = b.UseCode) as d group by [Rating Category]
order by Count desc


----------------------

select * into __SalesJan2018 from
(SELECT [Contract Account], [Rate Category], [Bill Amount], [Line item type]
FROM [CITY_POWER_MIDRAND].[dbo].SalesFromCityPower_Jan2018
where [Company Code] = '300') as d
where d.[Contract Account] in (select AccountNum from __Matched20968)



------------------ONE By One-----------

select  top 10 * from  SAP_MRQC_DATA_NEW where AccountNumber1 = '900705290'
select  top 10 * from  SalesFromCityPower_Dec2017 where [Contract Account] = '900705290'
select  top 10 * from  SalesFromCityPower_Jan2018 where [Contract Account] = '900705290'
select  top 10 * from  SalesFromCityPower_Feb2018 where [Contract Account] = '900705290'
select  top 10 * from  SalesFromCityPower_March2018 where [Contract Account] = '900705290'
select  top 10 * from  PrePaid_Midrand where [Stand No 2] = '1195' and AccountNumber = '900705290'
select * from  Midrand_Valuation_Property_Without_ST where isMatched = 0 and ERFUnitNo = '1195' and AccountNum = '900705290'
select * from  Midrand_Valuation2 where isMatched = 0 and ERFUnitNo = '1195' and AccountNumber = '900705290' --LegalDescription like '%Hill of good%' and ERFUnitNo = '222'

----------------------
select  top 10 * from  YDM_Dec_2017 where [SG Id] = 'T0IR0936000000002270000000'
select  top 10 * from  SAP_MRQC_DATA_NEW where AccountNumber1 = '800016377'
select  top 10 * from  SalesFromCityPower_Dec2017 where [Contract Account] = '800016377'
select  top 10 * from  SalesFromCityPower_Jan2018 where [Contract Account] = '800016377'
select  top 10 * from  SalesFromCityPower_Feb2018 where [Contract Account] = '800016377'
select  top 10 * from  SalesFromCityPower_March2018 where [Contract Account] = '800016377'
select  top 10 * from  PrePaid_Midrand where [Stand No 2] = '227' and [SAP No]= '4000186321' --and AccountNumber = '900705290'
select * from  Midrand_Valuation_Property_Without_ST where isMatched = 0 and ERFUnitNo = '227' and AccountNum = '800016377'
select * from  Midrand_Valuation2 where isMatched = 0 and ERFUnitNo = '227' and AccountNumber = '800016377'





-------------------------------------------------------------NEW IDEA EXCEPTION REDUCED-----------------------


select * from AnalysisDone_Midrand_Valuation_Property_Without_ST
where SG_ID='T0JR0187085000028160000000'

select * from Valuation2
where SG_ID like'%T0JR0187085000028160000000%'

select * from AnalysisDone_Midrand_Valuation2_Property
where AccountNumber = '554182744'

select * from CITY_POWER_RATE_MRQC.dbo.All_Registered_Properties_20180331 a
inner join AnalysisDone_Midrand_Valuation2_Property b
on a.[Rates Account Number] = b.AccountNumber
where a.SG_ID='T0JR0079137000008310000000'

select * from CITY_POWER_RATE_MRQC.dbo.All_Registered_Properties_20180331 a
inner join AnalysisDone_Midrand_Valuation_Property_Without_ST b
on a.[Rates Account Number] = b.AccountNum
where b.SG_ID='T0JR0079137000008310000000'



SELECT * FROM (select SG_ID, count(SG_ID) as cnt from CITY_POWER_RATE_MRQC.dbo.All_Registered_Properties_20180331 group by SG_ID) AS F where cnt > 1 ORDER BY cnt desc




--------------------------
Ormonde View
Thembalihle
Lehae SP
Zakariyya Park SP
Vlakfontein SP
Mid-Ennerdale
Ennerdale Ext 12, 13 & 14
Finetown
Lawley Ext 2
Lawley Ext 1
Riverlea
Fleurhof
Princess
Davidsonville
Matholesville
Tshepisong SP
Leratong Village
Durban Roodepoort Deep Gold Mine
----lufhereng------------------------
-------------Cosmo City----ESKOM Area
Bosmont
Westbury
Ormonde
Freedom Park
Devland
Eldorado Park
Alveda
Kibler Park 2
Naturena
Greenstone Hill(set prepaid which is not postpaid)
Commercia Ext 9(Friendship Town)
Rabie Ridge Ext 4(prepaid)
Klipfontein View




--select * from SalesFlatTable

--select AccountNumber from CITY_POWER_GIS.dbo.AnalysisDone_Midrand_Valuation2_Property where isMatched = 4

DECLARE @sTIN INT;
DECLARE @sP INT;
DECLARE @tP INT;
declare @AccountNumber nvarchar(100)
SET @sP = 1;
declare @DuplicatePIN table(AccountNumber nvarchar(100), id int identity(1,1)) 
insert into @DuplicatePIN
select  AccountNumber from CITY_POWER_GIS.dbo.AnalysisDone_Midrand_Valuation2_Property where isMatched = 1 and AccountNumber not in (select distinct [Contract Account June] from SalesFlatTable with (nolock))
select @tP = max(id) from @DuplicatePIN
--select * from @DuplicatePIN
WHILE @sP <= @tP
BEGIN

select @AccountNumber = AccountNumber from @DuplicatePIN where id = @sP
	print  @sP
print  @tP
print  @AccountNumber
--set @AccountNumber = '550060902'
insert into SalesFlatTable
select distinct * from (select [Contract Account] as [Contract Account June], [Line item type] as [Line item type June], [Bill Amount] as [Bill Amount June], [Rate Category] as [Rate Category June], [Bill Quantity] as [Bill Quantity June], [Unit Of Measure] as [Unit Of Measure June] from SalesForJunToMar_300_3 where MonthFiles = 'June2017'  and [Contract Account]= @AccountNumber) as a
left outer Join 
(select [Contract Account] as [Contract Account July], [Line item type] as [Line item type July], [Bill Amount] as [Bill Amount July], [Rate Category] as [Rate Category July], [Bill Quantity] as [Bill Quantity July], [Unit Of Measure] as [Unit Of Measure July] from SalesForJunToMar_300_3 where MonthFiles = 'July2017'  and [Contract Account]= @AccountNumber) as b
on a.[Contract Account June] = b.[Contract Account July] and a.[Line item type June] = b.[Line item type July]
left outer join
(select [Contract Account] as [Contract Account Aug], [Line item type] as [Line item type Aug], [Bill Amount] as [Bill Amount Aug], [Rate Category] as [Rate Category Aug], [Bill Quantity] as [Bill Quantity Aug], [Unit Of Measure] as [Unit Of Measure Aug] from SalesForJunToMar_300_3 where MonthFiles = 'Aug2017'  and [Contract Account]= @AccountNumber) as c
on a.[Contract Account June] = c.[Contract Account Aug] and a.[Line item type June] = c.[Line item type Aug]
left outer join
(select [Contract Account] as [Contract Account Sep], [Line item type] as [Line item type Sep], [Bill Amount] as [Bill Amount Sep], [Rate Category] as [Rate Category Sep], [Bill Quantity] as [Bill Quantity Sep], [Unit Of Measure] as [Unit Of Measure Sep] from SalesForJunToMar_300_3 where MonthFiles = 'Sep2017'  and [Contract Account]= @AccountNumber) as d
on a.[Contract Account June] = d.[Contract Account Sep] and a.[Line item type June] = d.[Line item type Sep]
left outer join
(select [Contract Account] as [Contract Account Oct], [Line item type] as [Line item type Oct], [Bill Amount] as [Bill Amount Oct], [Rate Category] as [Rate Category Oct], [Bill Quantity] as [Bill Quantity Oct], [Unit Of Measure] as [Unit Of Measure Oct] from SalesForJunToMar_300_3 where MonthFiles = 'Oct2017'  and [Contract Account]= @AccountNumber) as e
on a.[Contract Account June] = e.[Contract Account Oct] and a.[Line item type June] = e.[Line item type Oct]
left outer join
(select [Contract Account] as [Contract Account Nov], [Line item type] as [Line item type Nov], [Bill Amount] as [Bill Amount Nov], [Rate Category] as [Rate Category Nov], [Bill Quantity] as [Bill Quantity Nov], [Unit Of Measure] as [Unit Of Measure Nov] from SalesForJunToMar_300_3 where MonthFiles = 'Nov2017'  and [Contract Account]= @AccountNumber) as f
on a.[Contract Account June] = f.[Contract Account Nov] and a.[Line item type June] = f.[Line item type Nov]
left outer join
(select [Contract Account] as [Contract Account Dec], [Line item type] as [Line item type Dec], [Bill Amount] as [Bill Amount Dec], [Rate Category] as [Rate Category Dec], [Bill Quantity] as [Bill Quantity Dec], [Unit Of Measure] as [Unit Of Measure Dec] from SalesForJunToMar_300_3 where MonthFiles = 'Dec2017'  and [Contract Account]= @AccountNumber) as g
on a.[Contract Account June] = g.[Contract Account Dec] and a.[Line item type June] = g.[Line item type Dec]
left outer join
(select [Contract Account] as [Contract Account Jan], [Line item type] as [Line item type Jan], [Bill Amount] as [Bill Amount Jan], [Rate Category] as [Rate Category Jan], [Bill Quantity] as [Bill Quantity Jan], [Unit Of Measure] as [Unit Of Measure Jan] from SalesForJunToMar_300_3 where MonthFiles = 'Jan2018'  and [Contract Account]= @AccountNumber) as h
on a.[Contract Account June] = h.[Contract Account Jan] and a.[Line item type June] = h.[Line item type Jan]
left outer join
(select [Contract Account] as [Contract Account Feb], [Line item type] as [Line item type Feb], [Bill Amount] as [Bill Amount Feb], [Rate Category] as [Rate Category Feb], [Bill Quantity] as [Bill Quantity Feb], [Unit Of Measure] as [Unit Of Measure Feb] from SalesForJunToMar_300_3 where MonthFiles = 'Feb2018'  and [Contract Account]= @AccountNumber) as i
on a.[Contract Account June] = i.[Contract Account Feb] and a.[Line item type June] = i.[Line item type Feb]
left outer join
(select [Contract Account] as [Contract Account March], [Line item type] as [Line item type March], [Bill Amount] as [Bill Amount March], [Rate Category] as [Rate Category March], [Bill Quantity] as [Bill Quantity March], [Unit Of Measure] as [Unit Of Measure March] from SalesForJunToMar_300_3 where MonthFiles = 'Mar2018'  and [Contract Account]= @AccountNumber) as j
on a.[Contract Account June] = j.[Contract Account March] and a.[Line item type June] = j.[Line item type March]


set @sP = @sP + 1
END


----Depot
select * from (select IsMatched, count(IsMatched) as c from AnalysisDone_Midrand_Valuation_Property_Without_ST group by IsMatched) as sxadsa order by IsMatched
select * from (select IsMatched, count(IsMatched) as c from AnalysisDone_Midrand_Valuation2_Property group by IsMatched) as sxadsa order by IsMatched

select * from (select RatingCategory, count(RatingCategory) as Count from AnalysisDone_Midrand_Valuation_Property_Without_ST where isMatched = 0 group by RatingCategory) as sxadsa Order by Count desc
select * from (select UseDescription, count(UseDescription) as Count from AnalysisDone_Midrand_Valuation_Property_Without_ST where isMatched = 0 group by UseDescription) as sxadsa Order by Count desc

select * from (select RatingCategory, count(RatingCategory) as Count from AnalysisDone_Midrand_Valuation2_Property where isMatched = 0 group by RatingCategory) as sxadsa Order by Count desc
select * from (select UseDescription, count(UseDescription) as Count from AnalysisDone_Midrand_Valuation2_Property where isMatched = 0 group by UseDescription) as sxadsa Order by Count desc


select ISNULL(SG_ID, '') as [Property ID or SGID],PIN,ISNULL(Stand_No, '') as [Stand No],
AccountNumber as [Account No],LegalDescription as [Legal Description],
SearchAddress as [Address],RatingCategory as [Rating Category],UseCode as [Use Code],
cast(MarketValue As float) as [Market Value],cast(Extent As float) as Extent, 	
cast(XCoord as nvarchar(255)) + ', ' + cast(YCoord as nvarchar(255)) as [X,Y], 'C' as [Is Eskom or City Power], 
Region as [Region ID],Depot_Code as [Depot Code],	Depot_Name as [Depot Name], UseDescription from AnalysisDone_Midrand_Valuation2_Property 
where isMatched in (0) order by SG_ID desc















-----------------------------------

mrqc 10-11 month
\\10.1.15.15\DropBox\Rajesh\CityPowerInputData\City Power Files\To Bill\2018_01


Aug2017
Dec2017
Feb2018
Jan2018
July2017
June2017		
Mar2018
Nov2017
Oct2017
Sep2017




'E_L_TOUM_N'

'E_L_TOUL_N'

'E_L_LPUL_N',
'E_L_LPULAN',
'EL_L_LPUL',
'EL_L_LPULA'

'EL_L_LPUM',
'EL_L_LPUMA',
'E_L_LPUMAN',
'E_L_LPUM_N'

'E_B_BUS_1N',
'E_B_BUS_2N',
'E_B_BUS_3N',
'E_B_BUS_4N',
'E_B_BUS_5N',
'E_B_BUSA1N',
'E_B_BUSA2N',
'E_B_BUSA3N',
'E_B_BUSA4N',
'E_B_BUSA5N',
'EL_B_BUS',
'EL_B_BUS_1',
'EL_B_BUS_2',
'EL_B_BUS_3',
'EL_B_BUS_4',
'EL_B_BUS_5',
'EL_B_BUSA5',
'EL_B_BUSA4',
'EL_B_BUSA3',
'EL_B_BUSA2',
'EL_B_BUSA1'

'E_R_S1PH1N',
'E_R_S1PH2N',
'E_R_S1PH3N',
'E_R_S1PH5N',
'E_R_S3PH1N',
'E_R_S3PH2N',
'E_R_S3PH3N',
'E_R_S3PH5N',
'E_R_TOU1PN',
'EL_R_F1PA1',
'EL_R_F1PA2',
'EL_R_F1PA3',
'EL_R_F1PA4',
'EL_R_F1PA5',
'EL_R_F1PH',
'EL_R_F1PH1',
'EL_R_F1PH2',
'EL_R_F1PH3',
'EL_R_F1PH4',
'EL_R_F1PH5',
'EL_R_F1PHA',
'EL_R_F3PA1',
'EL_R_F3PA2',
'EL_R_F3PA3',
'EL_R_F3PA4',
'EL_R_F3PA5',
'EL_R_F3PH',
'EL_R_F3PH1',
'EL_R_F3PH2',
'EL_R_F3PH3',
'EL_R_F3PH4',
'EL_R_F3PH5',
'EL_R_F3PHA',
'EL_R_LIFE',
'EL_R_LIFE1',
'EL_R_LIFE2',
'EL_R_TOU1P',
'EL_R_S3PH4'



'E_B_RESELN',
'EL_B_RESEL'


'E_R_AGR_N'

'EL_R_RESEL'





select SUM(B) from (SELECT sum([Bill Quantity]) as B
FROM SalesJune2017
where [Rate Category] in
(
'EL_R_RESEL'
) and [Unit of Measure] = 'KWH' and [Bill Quantity] > 0
group by [Contract Account]) as d

union all

select SUM(B) from (SELECT sum([Bill Quantity]) as B
FROM SalesJune2017
where [Rate Category] in
(
'EL_R_RESEL'
) and [Unit of Measure] = 'KWH' and [Bill Quantity] < 0
group by [Contract Account]) as d

union all

select SUM(B) from (SELECT sum([Bill Quantity]) as B
FROM SalesJune2017
where [Rate Category] in
(
'EL_R_RESEL'
) and [Unit of Measure] = 'KWH' 
group by [Contract Account]) as d






declare @m nvarchar(50)
set @m = 'June2017'
select SUM(B) from (SELECT sum([Bill Amount]) as B
FROM [CITY_POWER_Sales].[dbo].[SalesForJunToMar]
where MonthFiles = @m and [Rate Category] in
(
'EL_R_RESEL'
) and [Unit of Measure] = 'KWH' and [Bill Amount] > 0
group by [Contract Account]) as d

union all

select SUM(B) from (SELECT sum([Bill Amount]) as B
FROM [CITY_POWER_Sales].[dbo].[SalesForJunToMar]
where MonthFiles = @m and [Rate Category] in
(
'EL_R_RESEL'
) and [Unit of Measure] = 'KWH' and [Bill Amount] < 0
group by [Contract Account]) as d

union all

select SUM(B) from (SELECT sum([Bill Amount]) as B
FROM [CITY_POWER_Sales].[dbo].[SalesForJunToMar]
where MonthFiles = @m and [Rate Category] in
(
'EL_R_RESEL'
) and [Unit of Measure] = 'KWH' 
group by [Contract Account]) as d


------------------------------------------------------
select sum([Bill Amount]) Sales_Jun2017_July2018_300 where MonthFiles = 'June2017'

--and [Unit of Measure] = 'KWH'
select  sum([Bill Amount]) from Sales_Jun2017_July2018_300  where MonthFiles = 'June2017'  and [Line item type] = 'YECONS' and [Bill Amount] > 0

select  top 5 * from Sales_Jun2017_July2018_300  where MonthFiles = 'June2017' and [Unit of Measure] = 'KWH'


1323593918,97
1016128140,93

2509140309,67




5Sep2018

declare @TempData table(ACCNum nvarchar(200), Billed decimal(18,4))

declare @CC int;
set @CC = 100;


insert into @TempData
select Z.ACCNum, (Z.amt0 + Y.amt1) as billed from
(select ACCNum, sum(BAmount) as amt0 from
(select [Contract Account] as ACCNum, [Bill Amount] as BAmount from SalesJune2018 where [Line item type] in ('YVLEVY', 'YVFRE2', 'YVRSEC')  and  [Company Code] = @CC and [Bill Amount] < 0 and [Contract Account] in (select  AccountNumber from Valuation_CityPower_5SEP2018 where SewerMatched != 0))  as d
group by ACCNum) as Z

inner join 
(select ACCNum, sum(BAmount) as amt1 from
(select [Contract Account] as ACCNum, [Bill Amount] as BAmount from SalesJune2018 where [Line item type] in ('YVLEVY', 'YVFRE2', 'YVRSEC')  and  [Company Code] = @CC and [Bill Amount] > 0 and [Contract Account] in (select  AccountNumber from Valuation_CityPower_5SEP2018 where SewerMatched != 0))  as d
group by ACCNum) as Y
on Z.ACCNum = Y.ACCNum

select * from @TempData
order by billed


select L, count(Acc) as dd from (select  [Line item type] as L, [Contract Account] as Acc from SalesJune2018 where [Company Code] = '300') as d group by L order by dd desc


Rates
[Line item type] in ('YVLEVY', 'YVFRE2', 'YVRSEC')
water
'YRREM2', 'YESP', 'YRCCL', 'YRREM'
Power
'YESP','YENET','YESERC','YEDSM','YECONS','YRSL','YDEAMT','YEREAC','YEOFFP','YETOUS','YESTD','YEPEAK','YECONV','YEFREE'
[Rate Category] in ('E_L_TOUM_N','E_L_TOUL_N','E_L_LPUL_N','E_L_LPULAN','EL_L_LPUL','EL_L_LPULA','EL_L_LPUM','EL_L_LPUMA','E_L_LPUMAN','E_L_LPUM_N','E_B_BUS_1N','E_B_BUS_2N','E_B_BUS_3N','E_B_BUS_4N','E_B_BUS_5N','E_B_BUSA1N','E_B_BUSA2N','E_B_BUSA3N','E_B_BUSA4N','E_B_BUSA5N','EL_B_BUS','EL_B_BUS_1','EL_B_BUS_2','EL_B_BUS_3','EL_B_BUS_4','EL_B_BUS_5','EL_B_BUSA5','EL_B_BUSA4','EL_B_BUSA3','EL_B_BUSA2','EL_B_BUSA1','E_R_S1PH1N','E_R_S1PH2N','E_R_S1PH3N','E_R_S1PH5N','E_R_S3PH1N','E_R_S3PH2N','E_R_S3PH3N','E_R_S3PH5N','E_R_TOU1PN','EL_R_F1PA1','EL_R_F1PA2','EL_R_F1PA3','EL_R_F1PA4','EL_R_F1PA5','EL_R_F1PH','EL_R_F1PH1','EL_R_F1PH2','EL_R_F1PH3','EL_R_F1PH4','EL_R_F1PH5','EL_R_F1PHA','EL_R_F3PA1','EL_R_F3PA2','EL_R_F3PA3','EL_R_F3PA4','EL_R_F3PA5','EL_R_F3PH','EL_R_F3PH1','EL_R_F3PH2','EL_R_F3PH3','EL_R_F3PH4','EL_R_F3PH5','EL_R_F3PHA','EL_R_LIFE','EL_R_LIFE1','EL_R_LIFE2','EL_R_TOU1P','EL_R_S3PH4','E_B_RESELN','EL_B_RESEL','E_R_AGR_N','EL_R_RESEL')

Sewer
'YWCONS','YESP','YSBASC','YWADML','YWBASC','YSCONS','YRSL','YWCONV','YSCONV','YIEBAS'


select acc, sum(b) as bill from
(SELECT [Contract Account] as acc, [Bill Amount] as b
  FROM [COJProp].[dbo].[SalesJuly2018]

  where [Company Code] = '200' and [Bill Amount] < 0)  as d group by acc order by bill
  
  
  ===========================================================
  
  ----------------Records
  select * from [WallyEl_Rates_Meters_Rate Cat] where ElectricityContAccount in
  (
  select distinct ElectricityContAccount from [WallyEl_Rates_Meters_Rate Cat]
  where 
  Device  not in
  (select AccNum from 
  (select distinct DeviceSerialNo as AccNum from YDM_20_July_2018) as X
  
  inner join 
  (select distinct Device as AccNum_AML from [WallyEl_Rates_Meters_Rate Cat] where ElectricityDv = 1) as Y
  on x.AccNum = Y.AccNum_AML) and ElectricityDv = 1
  
  ) and ElectricityDv = 1 
  order by Device
  
  
  
  ----------------Accounts
  select distinct ElectricityContAccount from [WallyEl_Rates_Meters_Rate Cat]
  where 
  Device  not in
  (select AccNum from 
  (select distinct DeviceSerialNo as AccNum from YDM_20_July_2018) as X
  
  inner join 
  (select distinct Device as AccNum_AML from [WallyEl_Rates_Meters_Rate Cat] where ElectricityDv = 1) as Y
  on x.AccNum = Y.AccNum_AML) and ElectricityDv = 1
