


count(*)
(geometry::STGeomFromText(g.WKT, 4326))  as wkt

select * from GV_DC_APP.dbo.GeometryData_Temp 
select count(*) from PARCEL_Register
select * from PARCEL_Approved


select T.PIN, T.WKT, d.GISKey into EData from GV_DC_APP.dbo.GeometryData_Temp T inner join DW_VM_LIVE.dbo.RECORD d
on T.PIN = d.pin

ALTER TABLE EData ADD geom geometry

ALTER TABLE EData ADD ParcelID int

update EData set geom = (geometry::STGeomFromText(WKT, 4326)).MakeValid()

update EData set ParcelID = p.ID from EData e inner join PARCEL_Approved p on e.GISKey = p.LMKey

insert into PARCEL_Approved(LMKEY, Parcel)
select GISKey, geom  from EData
where GISKey NOT IN (select LMKey from PARCEL_Approved)


insert  PARCEL_Register(LMKey, parcel, centrepoint, CentreX, CentreY, ParcelID)
select GISKey, geom, geom.STCentroid(), geom.STCentroid().STX, geom.STCentroid().STY, ParcelID from EData
where GISKey NOT IN (select LMKey from PARCEL_Register)


update PARCEL_Register set parcel = e.geom from EData e inner join PARCEL_Register p
on e.GISKey = p.LMKey

ALTER TABLE PARCEL_Register ADD Geomt geometry

update PARCEL_Register set Geomt = e.geom from EData e inner join PARCEL_Register p
on e.GISKey = p.LMKey



update PARCEL_Register set parcel = Geomt 

DROP INDEX geom_sidx ON PARCEL_Register

update PARCEL_Register set centrepoint = parcel.STCentroid(), CentreX = parcel.STCentroid().STX, CentreY = parcel.STCentroid().STY

CREATE INDEX geom_sidx
ON PARCEL_Register(parcel)



sp_helptext RequiresInvestigationOrReview


[dbo].[GetNearestBounderyForWeb] 8095007


declare @G geometry;  
Declare @dedsTown varchar(10)
select @g = Location,@dedsTown=Allotment  from DW_VM_LIVE.dbo.RECORD with(nolock) where PIN =  8095007  
select  *   from DW_VM_LIVE.dbo.RECORD  where @g.STBuffer(0.0011).STIntersects(Location) = 1 and PIN !=  8095007 
and Allotment= @dedsTown


 
  select Location  from DW_VM_LIVE.dbo.RECORD with(nolock) where PIN =  8095007  
  
  
  
  select count(PIN) from DW_VM_LIVE.dbo.record with (nolock) where Location is null
  select count(PIN) from GV_DC_APP.dbo.PropertyBoundery with (nolock) where geom is null
  
  

select b.geom from DW_VM_LIVE.dbo.record a with (nolock)
inner join COJ_GV2018_LIVE.dbo.__OMCOJ_Reg_26March2018_stat1_Wgs84 b with (nolock)
on a.PIN = b.VA3_PIN
where a.Location is null

update DW_VM_LIVE.dbo.record
set Location = b.geom.MakeValid()
from DW_VM_LIVE.dbo.record a with (nolock)
inner join COJ_GV2018_LIVE.dbo.__OMCOJ_Reg_26March2018_stat1_Wgs84 b with (nolock)
on a.PIN = b.VA3_PIN
where a.Location is null


select top 5 * from DW_VM_LIVE.dbo.record with (nolock) where PIN = 8095007 

select top 5 * from GV_DC_APP.dbo.PropertyBoundery with (nolock) where PIN = 8095007 

select top 5 * from COJ_GV2018_LIVE.dbo.__OMCOJ_Reg_26March2018_stat1_Wgs84 with (nolock) where VA3_PIN = 8095007 

select top 5 * from COJ_GV2018_LIVE.dbo.GeometryData with (nolock) where PIN = 8095007 

select top 5 * from GV_DC_APP.dbo.NeighbourMapping with (nolock) where PIN = 8095007 



INSERT INTO [dbo].[PropertyBoundery]           ([PIN]           ,[WKT]           ,[IsDownloaded]           ,[IMEI]           ,[UserID]           ,[geom]           ,[X]
           ,[Y]
           ,[Caption]
           ,[UseCode]
           ,[Extent]
           ,[Ownership])

   select VA3_PIN, geom.MakeValid().STAsText(),0,'',0, geom.MakeValid(), geom.MakeValid().STCentroid().STX, geom.MakeValid().STCentroid().STY, PROPERTY_D, 'J08', gis_extent, OWNER from COJ_GV2018_LIVE.dbo.__OMCOJ_Reg_26March2018_stat1_Wgs84 with (nolock) where VA3_PIN = 8094355 


select top 5 * from DW_LM_SPATIAL.dbo.Township with (nolock) where Allotment = 2325 

select top 5 * from DW_VM_LIVE.dbo._Township_map with (nolock) where TOWN_NUMBER = 2325 

--------------------------------------------DATA LOAD---------------------------------------

[GV_DC_APP].[dbo].[DD_maidibeng_CadastralPins_14June2018__WGS84_SHAPEFILEDATA]
[COJ_GV2018_LIVE].[dbo].[GeometryData]
[DW_VM_LIVE].[dbo].[RECORD]
[GV_DC_APP].[dbo].[Batch]
[GV_DC_APP].[dbo].[BatchPINS]
[GV_DC_APP].[dbo].[PropertyBoundery]



--58101 rows affected
  update [DW_VM_LIVE].[dbo].[RECORD]
  set Location =b.geom,
  CenterX = b.X_WGS84, CenterY = b.Y_WGS84, XCoord = b.X_Coord, YCoord=b.Y_Coord
  from [DW_VM_LIVE].[dbo].[RECORD] a 
inner join [GV_DC_APP].[dbo].[DD_maidibeng_CadastralPins_14June2018__WGS84_SHAPEFILEDATA] b
on a.Pin = b.PIN

select * from [DW_VM_LIVE].[dbo].[RECORD] where Location is null
select count(*) from [DW_VM_LIVE].[dbo].[RECORD] --where Location is null
select count(*) FROM [GV_DC_APP].[dbo].[DD_maidibeng_CadastralPins_14June2018__WGS84_SHAPEFILEDATA]


select * from [GV_DC_APP].[dbo].[BatchPINS] a
inner join [GV_DC_APP].[dbo].[DD_maidibeng_CadastralPins_14June2018__WGS84_SHAPEFILEDATA] b
on a.PIN = b.PIN

update [GV_DC_APP].[dbo].[BatchPINS]
set X = b.Y_WGS84, Y = b.X_WGS84
from [GV_DC_APP].[dbo].[BatchPINS] a
inner join [GV_DC_APP].[dbo].[DD_maidibeng_CadastralPins_14June2018__WGS84_SHAPEFILEDATA] b
on a.PIN = b.PIN




INSERT INTO [dbo].[PropertyBoundery]
           ([PIN]
           ,[WKT]
           ,[IsDownloaded]
           ,[IMEI]
           ,[UserID]
           ,[geom]
           ,[X]
           ,[Y]
           ,[Caption]
           ,[UseCode]
           ,[Extent]
           ,[Ownership])

select PIN,Location.STAsText(), 0,'',0, Location, CenterX,CenterY,RecordDescription, UseCode, Extent,Ownership from [DW_VM_LIVE].[dbo].[RECORD]



select geometry::STGeomFromText('POINT ('+cast(Y as nvarchar(30))+' '+cast(X as nvarchar(30))+')', 4326) as geom, BatchID into __TEMP from [GV_DC_APP].[dbo].[BatchPINS]

select * into __TEMP2 from (select (geometry::UnionAggregate(geom)).STEnvelope().STCentroid() as UGEOM, BatchID from __TEMP group by BatchID) as d

update Batch set BatchGeom = b.UGEOM from Batch a inner join __TEMP2 b on a.BatchID = b.BatchID



############  MSUNDUZI   ##############################



select top 10 * from [GV_DC_APP].[dbo].[Msunduzi_GV2019_PropertyRegister_4July2018_WGS84]
select * from [COJ_GV2018_LIVE].[dbo].[GeometryData]
select * from [DW_VM_LIVE].[dbo].[RECORD]
select * from [GV_DC_APP].[dbo].[Batch]
select * from [GV_DC_APP].[dbo].[BatchPINS]
select * from [GV_DC_APP].[dbo].[PropertyBoundery]
select top 10 * from DW_LM_SPATIAL.dbo.PropertyRegistration






  update [DW_VM_LIVE].[dbo].[RECORD]
  set Location =b.geom.MakeValid(),
  CenterX = b.WX1, CenterY = b.WY1, XCoord = b.X, YCoord=b.Y, GISKey = b.SGCODE 
  from [DW_VM_LIVE].[dbo].[RECORD] a 
inner join [GV_DC_APP].[dbo].[Msunduzi_GV2019_PropertyRegister_4July2018_WGS84] b
on a.Pin = b.PIN



INSERT INTO [GV_DC_APP].[dbo].[PropertyBoundery]
           ([PIN]
           ,[WKT]
           ,[IsDownloaded]
           ,[IMEI]
           ,[UserID]
           ,[geom]
           ,[X]
           ,[Y]
           ,[Caption]
           ,[UseCode]
           ,[Extent]
           ,[Ownership])

select PIN,Location.STAsText(), 0,'',0, Location, CenterX,CenterY,RecordDescription, UseCode, Extent,Ownership from [DW_VM_LIVE].[dbo].[RECORD]



select geometry::STGeomFromText('POINT ('+cast(Y as nvarchar(30))+' '+cast(X as nvarchar(30))+')', 4326) as geom, BatchID into DW_VM_LIVE.dbo.__TEMP from [GV_DC_APP].[dbo].[BatchPINS]

select * into DW_VM_LIVE.dbo.__TEMP2 from (select (geometry::UnionAggregate(geom)).STEnvelope().STCentroid() as UGEOM, BatchID from DW_VM_LIVE.dbo.__TEMP group by BatchID) as d

update [GV_DC_APP].[dbo].[Batch] set BatchGeom = b.UGEOM from [GV_DC_APP].[dbo].[Batch] a inner join DW_VM_LIVE.dbo.__TEMP2 b on a.BatchID = b.BatchID

select * from [GV_DC_APP].[dbo].[Batch] a inner join DW_VM_LIVE.dbo.__TEMP2 b on a.BatchID = b.BatchID


select * from [GV_DC_APP].[dbo].[BatchPINS] a
inner join [DW_VM_LIVE].[dbo].[RECORD] b
on a.PIN = b.PIN

select * from [GV_DC_APP].[dbo].[BatchPINS] a
inner join [GV_DC_APP].[dbo].[Msunduzi_GV2019_PropertyRegister_4July2018_WGS84] b
on a.PIN = b.PIN

update [GV_DC_APP].[dbo].[BatchPINS]
set X = b.WY1, Y = b.WX1
from [GV_DC_APP].[dbo].[BatchPINS] a
inner join [GV_DC_APP].[dbo].[Msunduzi_GV2019_PropertyRegister_4July2018_WGS84] b
on a.PIN = b.PIN




INSERT INTO COJ_GV2018_LIVE.[dbo].[GeometryData]
           ([GEOM]
           ,[PIN5]
           ,[X_LO]
           ,[Y_LO]
           ,[X_LO1]
           ,[Y_LO1]
           ,[PIN])
    select  [GEOM], pin, X, Y, X, Y, PIN from [GV_DC_APP].[dbo].[Msunduzi_GV2019_PropertyRegister_4July2018_WGS84]


drop table DW_VM_LIVE.dbo.__TEMP2
drop table DW_VM_LIVE.dbo.__TEMP





#################################COJ UPDATE###########################


INSERT INTO DW_VM_LIVE.dbo.RECORD
(PIN, RecordDescription, Location, CenterX, CenterY, PREMISID, XCoord, YCoord)


select pin_1, PROPERTY_D, geom.MakeValid(),geom.MakeValid().STCentroid().STX, geom.MakeValid().STCentroid().STY, PREMISEID,X_COORD, Y_COORD
from [14__COJ_SUPP1G_2016_imagery_only_WGS84] where iexist = 0


