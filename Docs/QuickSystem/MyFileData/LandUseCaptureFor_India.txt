Please download VPN client software from our ftp
Ftp://14.140.249.134
Username: vpn
Password: @atl#vpn
 Download AnyConnect from ftp and install
After installation open it
You be asked for IP address
Give 14.140.249.130
VPN username: dworld
Password: @atl#geo$98
 Username : admin
Password : 8WmP=c7F
 Username: sa
Password: SQL4D@tab@se


file://C:\Geoserver\Data\LandUseCaptureShape\Education\Universities.shp

Server Name: DWJHBGISSVR
IP Address: 10.1.15.220
Public IP Address: 41.189.71.139
User Name : DWJHBGISSVR\Administrator
P/w: Dbnadmin@2017





NewUseCode		: 	for usecode
vBatchCounts(View)	:	for QA ADMIN Report
CadastralMain		:	Main Cad Layer

http://10.1.101.101:8085/geoserver/web

select top 5 * from CadastralMain
select top 5 * from User_Batch
select top 5 * from Pin_DesktopReviewMain



UPDATE [dbo].[CadastralMain]
   SET[CapturedUse] = ''
      ,[CapturedBy] = ''
      ,[CaptureStamp] = ''
      ,[CaptureRemarks] = ''
      ,[Status] = ''
      ,[BatchNumber] = 0
      ,[QAUse] = ''
      ,[QABy] = ''
      ,[QAStamp] = ''
      ,[QARemarks] = ''
      ,[QAStatus] = ''
      
      
       delete Pin_DesktopReviewMain
       delete User_Batch


 
 

http://DWJHBGISSVR/landusecapture3/login.aspx
http://41.189.71.139/landusecapture3/login.aspx

  select *, ((CaptureDone * 100) / TotalPin) as num from (select BatchNumber, count(Pin) as TotalPin, count(CaptureStatus) as CaptureDone, count(QAStatus) as QADoneIndia
  from Pin_DesktopReviewMain with (nolock)
  group by BatchNumber) as a where CaptureDone < 2
  
  
  http://dwjhbgissvr:8086/geoserver/web
  
  http://dwjhbgissvr:8085/geoserver/web
  
UPDATE [dbo].[CadastralMain]
   SET
      [QAUse1] = ''
      ,[QABy1] = ''
      ,[QAStamp1] = ''
      ,[QARemarks1] = ''
      ,[QAStatus1] = '' 

update Pin_DesktopReviewMain set DwQA1 = null, QAStatus1 = null	  




###################################
--Delete duplicate pin Pin_DesktopReviewMain

select * from (select count(PIN) as d, PIN from Pin_DesktopReviewMain group by  Pin) as g where d> 1
ALTER TABLE Pin_DesktopReviewMain ADD TID int identity(1,1)

DECLARE @sTIN INT;
DECLARE @sP INT;
DECLARE @tP INT;
SET @sP = 1;
declare @DuplicatePIN table(PIN int, id int identity(1,1)) 
insert into @DuplicatePIN
SELECT        distinct Pin
FROM            Pin_DesktopReviewMain
WHERE        (Pin IN
                             (SELECT        Pin
                               FROM            (SELECT        COUNT(Pin) AS d, Pin
                                                         FROM            Pin_DesktopReviewMain AS Pin_DesktopReviewMain_1
                                                         GROUP BY Pin) AS g
                               WHERE        (d > 1)))
ORDER BY Pin
select @tP = count(PIN) from (select distinct PIN from @DuplicatePIN) as d
print @tP
WHILE @sP <= @tP
BEGIN
	select @sTIN = tid from (select top 1 tid from Pin_DesktopReviewMain where PIN = (select pin from @DuplicatePIN where id = @sP)) as df
	delete from Pin_DesktopReviewMain where tid = @sTIN

	set @sP = @sP + 1
END

delete @DuplicatePIN
ALTER TABLE Pin_DesktopReviewMain DROP  COLUMN TID ;  




##########################
test Database

select * into LandUseCapture4.dbo.CadastralMain from LandUseCapture2.dbo.CadastralMain
select * into LandUseCapture4.dbo.CadastralMainArchive from LandUseCapture2.dbo.CadastralMainArchive
select * into LandUseCapture4.dbo.Pin_DesktopReviewMain from LandUseCapture2.dbo.Pin_DesktopReviewMain
select * into LandUseCapture4.dbo.Pin_DesktopReviewMainArchive from LandUseCapture2.dbo.Pin_DesktopReviewMainArchive
select * into LandUseCapture4.dbo.cadPINArchive from LandUseCapture2.dbo.cadPINArchive
select * into LandUseCapture4.dbo.CadPIN from LandUseCapture2.dbo.CadPIN


DROP TABLE LandUseCapture4.dbo.CadastralMain
DROP TABLE LandUseCapture4.dbo.CadastralMainArchive
DROP TABLE LandUseCapture4.dbo.Pin_DesktopReviewMain
DROP TABLE LandUseCapture4.dbo.Pin_DesktopReviewMainArchive
DROP TABLE LandUseCapture4.dbo.cadPINArchive
DROP TABLE LandUseCapture4.dbo.CadPIN




DECLARE @BatchNumber bigint;
SET @BatchNumber = 2017416195;

insert into CadastralMainArchive 
([BatchNumber]
,[CapturedUse]
,[CapturedBy]
,[CaptureRemarks]
,[CaptureStamp]
,[Status]
,[QABy]
,[QARemarks]
,[QAStamp]
,[QAStatus]
,[QAUse]
,[PIN])
select 
[BatchNumber]
,[CapturedUse]
,[CapturedBy]
,[CaptureRemarks]
,[CaptureStamp]
,[Status]
,[QABy]
,[QARemarks]
,[QAStamp]
,[QAStatus]
,[QAUse]
,[PIN] 
from CadastralMain with (nolock) 
where BatchNumber = @BatchNumber


insert into Pin_DesktopReviewMainArchive 
 ([Pin]
           ,[DwCapturer]
           ,[CaptureStatus]
           ,[DwQA]
           ,[QAStatus]
           ,[BatchNumber])
select  
[Pin]
           ,[DwCapturer]
           ,[CaptureStatus]
           ,[DwQA]
           ,[QAStatus]
           ,[BatchNumber]
from  Pin_DesktopReviewMain with (nolock) where BatchNumber = @BatchNumber

insert into cadPINArchive 
([PointGeom]
           ,[UseCodeCaptured]
           ,[UseCodeQA]
           ,[PIN])
select  
[PointGeom]
           ,[UseCodeCaptured]
           ,[UseCodeQA]
           ,[PIN] 
from CadPIN where pin in (select PIN from CadastralMain with (nolock) where BatchNumber = @BatchNumber)




delete from  LandUseCapture4.dbo.CadastralMainArchive

delete from  LandUseCapture4.dbo.Pin_DesktopReviewMainArchive
delete from  LandUseCapture4.dbo.cadPINArchive

















/****** Script for SelectTopNRows command from SSMS  ******/
SELECT Province,DM,LM,BoundarySource,SGCode,parcel_no,portion,maj_region,maj_code,SHAPE_AREA,HA,Boundary.STAsBinary() as WKT,CapturedUse,CapturedBy,CaptureStamp,CaptureRemarks,Status,BatchNumber,QAUse,QABy,QAStamp,QARemarks,QAStatus,PIN  FROM CadastralMain   where CapturedUse != ''

ogr2ogr -f "ESRI Shapefile" "E:\DLL\Data16Aug2017.shp" "MSSQL:server=GEOSERVER; database=LandUseCapture2;uid=sa;pwd=SQL4D@tab@se" -sql "SELECT Province,DM,LM,BoundarySource,SGCode,parcel_no,portion,maj_region,maj_code,SHAPE_AREA,HA,Boundary.STAsBinary() as WKT,CapturedUse,CapturedBy,CaptureStamp,CaptureRemarks,Status,BatchNumber,QAUse,QABy,QAStamp,QARemarks,QAStatus,PIN  FROM CadastralMain   where CapturedUse != ''"




  
Select     
BatchNumber,
TotalPIN,  
(Select count(PIN) from CadastralMain with(nolock) where BatchNumber = a.BatchNumber and CapturedUse != '') as PinComplete,  
(Select count(PIN) from CadastralMain with(nolock) where BatchNumber = a.BatchNumber and CapturedUse = '') as PinRemaining,
(Select distinct CapturedBy from CadastralMain with(nolock) where BatchNumber = a.BatchNumber and CapturedUse != '') as CapturedBy,
(Select distinct Province from CadastralMain with(nolock) where BatchNumber = a.BatchNumber and CapturedUse != '') as Province,
(Select distinct DM from CadastralMain with(nolock) where BatchNumber = a.BatchNumber and CapturedUse != '') as DM,
(Select distinct LM from CadastralMain with(nolock) where BatchNumber = a.BatchNumber and CapturedUse != '') as LM,
(Select distinct CONVERT(date, CaptureStamp) from CadastralMain with(nolock) where BatchNumber = a.BatchNumber and CapturedUse != '' and CONVERT(date, CaptureStamp) = '2017-08-14') as CaptureStamp 
from(  
Select BatchNumber, count(PIN) as TotalPIN  from CadastralMain with(nolock)  group by BatchNumber
)a

where a.BatchNumber != 0



update CadastralMain 
set CapturedUse = d.CapturedUs,
CapturedBy = d.CapturedBy,
CaptureStamp  = d.CaptureSta,
CaptureRemarks  = d.CaptureRem,
Status  = d.Status,
BatchNumber  = d.BatchNumbe
from Data14Aug2017 d
inner join CadastralMain c
on d.pin = c.pin



So 
I need to write a sync application.

Sync application will runs after working hours.
Server(10.1.15.220 server in SA) needs to be connected through VPN(Which can't be automated).

Syncing Rule:-
Batch will sync after
o	All pins captured against the BatchNumber
o	At least 30% pin QAed  against the BatchNumber
	

India SQL Database should connect outside the RDP. Currently I can’t connect.



http://dwjhbgissvr:8086/geoserver/web

http://dwjhbgissvr:8085/geoserver/topp/wms?service=WMS&version=1.1.0&request=GetMap&layers=topp:tasmania_water_bodies&styles=&bbox=145.97161899999998,-43.031944,147.219696,-41.775558&width=508&height=512&srs=EPSG:4326&format=application/openlayers

http://10.1.15.220:8085/geoserver/topp/wms?service=WMS&version=1.1.0&request=GetMap&layers=topp:tasmania_water_bodies&styles=&bbox=145.97161899999998,-43.031944,147.219696,-41.775558&width=508&height=512&srs=EPSG:4326&format=application/openlayers




http://dwjhbgissvr:8086/geoserver/gwc/service/wms?LAYERS=LUCVector:LUCActiveMines&FORMAT=image/jpeg&SERVICE=WMS&VERSION=1.1.1&REQUEST=GetMap&STYLES=&SRS=EPSG:900913&BBOX=3287403.7120312,-4070118.8815625,3365675.2289844,-3991847.3646093&WIDTH=256&HEIGHT=256

http://lists.osgeo.org/pipermail/openlayers-users/2010-June/018090.html




select * into ADR.dbo.ExpCadPin from cadpin with(nolock) where PIN in (select PIN from ADR.dbo.Exp)
select PIN, CapturedUse, CaptureStamp, QAUse as INDIAQAUse, QAStamp as INDIAQAStamp INTO Adr.dbo.Exp from (select * from CadastralMain with (nolock) where CapturedUse != '') as d where cast(CaptureStamp as date) < cast(Getdate() as date)



declare @FinalData table(OID int, PIN int, id int identity(1,1))
declare @BatchNum bigint
DECLARE @sP INT;
DECLARE @tP INT;
SET @sP = 1;

set @tP = 1326;
WHILE @sP <= @tP
BEGIN
	insert into @FinalData select @sP, PIN from CadastralMain2 c where c.geom.MakeValid().STIntersects((select geom.MakeValid().STCentroid() from AdhirData_FarmPortions_AddedAreas where OID = @sP)) = 1
	print @sP
	set @sP = @sP + 1;
END
select * into DataAdr from @FinalData


ogr2ogr -f "ESRI Shapefile" "H:\ProjDesc\LandUseCapture_Midval\ChildCadData.shp" "MSSQL:server=DWJHBGISSVR; database=Adr;uid=sa;pwd=java" -sql "select OID,PIN,Captured,QALevel1,QALevel2,Geom.STAsBinary() as Geom,QAFinal,Category,UseCode,Province,DM,LM from ChildCadData"

ogr2ogr -f "ESRI Shapefile" "H:\ProjDesc\LandUseCapture_Midval\CadMainData.shp" "MSSQL:server=DWJHBGISSVR; database=Adr;uid=sa;pwd=java" -sql "SELECT OID,PIN,QALevel2,Captured,QALevel1,Geom.STAsBinary() as Geom,QAFinal,Province,DM,LM,Category,UseCode  FROM CadMainData"




--select OID, PIN, Captured, QALevel1, QALevel2, QAFinal from CadMainData order by OID desc

--select OID, PIN, Captured, QALevel1, QALevel2, QAFinal from CadMainData order by OID desc

declare @PIN int;
declare @Captured nvarchar(255);
declare @QALevel1 nvarchar(255); 
declare @QALevel2 nvarchar(255);
declare @QAFinal nvarchar(255);

DECLARE @sP INT;
DECLARE @tP INT;
SET @sP = 1;
SET @tP = 482120;

WHILE @sP <= @tP
BEGIN
	select @PIN = PIN, @Captured = Captured, @QALevel1 = QALevel1, @QALevel2 = QALevel2 from CadMainData where OID = @sP
	IF @QALevel2 = ''
		BEGIN
				IF @QALevel1 = ''
					BEGIN
							set @QAFinal = @Captured;
					END
				ELSE
					BEGIN
						set @QAFinal = @QALevel1;
					END
		END
	ELSE
		BEGIN
			set @QAFinal = @QALevel2;
		END
		print '';
		print @QAFinal;
		print @sP;
		print @PIN;
		update CadMainData set QAFinal = @QAFinal where PIN = @PIN
	set @sP = @sP + 1;
END







DECLARE @NUM varchar(50);
DECLARE @Category varchar(50);
DECLARE @UseCode varchar(50);
DECLARE @sP INT;
DECLARE @tP INT;
SET @sP = 1;
SET @tP = 83;

WHILE @sP <= @tP
BEGIN
	select @NUM = number, @Category = Category, @UseCode = UseCode from NewUseCode where Id = @sP
	update  ChildCadData set Category = @Category, UseCode = @UseCode  where QAFinal like '%'+@NUM+'%'
	set @sP = @sP + 1;
END



	update ChildCadData
	set Province = b.Province, LM = b.LM, DM = b.DM 
	 from ChildCadData a inner join LandUseCapture2.dbo.CadastralMain2 b
	on a.PIN = b.PIN
	
	update CadMainData
		set Province = b.Province, LM = b.LM, DM = b.DM   from 	 CadMainData a inner join LandUseCapture2.dbo.CadastralMain2 b
	on a.PIN = b.PIN
	
	
	
	
	
	
	
	DECLARE @NUM varchar(50);
	DECLARE @Category varchar(50);
	DECLARE @UseCode varchar(50);
	DECLARE @sP INT;
	DECLARE @tP INT;
	SET @sP = 84;
	SET @tP = 84;
	
	WHILE @sP <= @tP
	BEGIN
		select @NUM = number, @Category = Category, @UseCode = UseCode from NewUseCode where Id = @sP
		update  CadMainData set Category = @Category, UseCode = @UseCode  where QAFinal like '%'+@NUM+'%'
		print @NUM
		print @Category
		print @UseCode
		print @sP
			print ''
		set @sP = @sP + 1;
	END
	
	DECLARE @NUM varchar(50);
	set @NUM = 23
	select * from CadMainData where QAFinal like '%'+@NUM+'%'
	
	update  CadMainData set Category = '', UseCode = ''  where QAFinal = ''
	
	update  CadMainData set UseCode = REPLACE(UseCode, '–', ' ')
	
update  ChildCadData set UseCode = REPLACE(UseCode, '–', ' ')



declare @FinalData table(Province varchar(25), ParentPINCount int, ChildPINCount int,ParentSliverCount int, ChildSliverCount int , id int identity(1,1))
 declare @Province varchar(25) 
 declare @pCount int
 declare @cCount int
  declare @ParentSliverCount int
 declare @ChildSliverCount int

 set @Province = 'EC'
select @pCount = count(*) from CP2 where Province = @Province
select @cCount = count (b.PIN) from CP2 a inner join ChildCadData b on a.PIN = b.PIN where a.Province = @Province and a.usecode <> b.usecode
   select @ParentSliverCount = count(*) from CP2 where usecode = 'Sliver' and Province = @Province
select @ChildSliverCount = count(*) from ChildCadData where usecode = 'Sliver' and Province = @Province
 insert into @FinalData select @Province, @pCount, @cCount, @ParentSliverCount, @ChildSliverCount

  set @Province = 'FS'
select @pCount = count(*) from CP2 where Province = @Province
select @cCount = count (b.PIN) from CP2 a inner join ChildCadData b on a.PIN = b.PIN where a.Province = @Province and a.usecode <> b.usecode
  select @ParentSliverCount = count(*) from CP2 where usecode = 'Sliver' and Province = @Province
select @ChildSliverCount = count(*) from ChildCadData where usecode = 'Sliver' and Province = @Province
 insert into @FinalData select @Province, @pCount, @cCount, @ParentSliverCount, @ChildSliverCount

  set @Province = 'GT'
select @pCount = count(*) from CP2 where Province = @Province
select @cCount = count (b.PIN) from CP2 a inner join ChildCadData b on a.PIN = b.PIN where a.Province = @Province and a.usecode <> b.usecode
   select @ParentSliverCount = count(*) from CP2 where usecode = 'Sliver' and Province = @Province
select @ChildSliverCount = count(*) from ChildCadData where usecode = 'Sliver' and Province = @Province
 insert into @FinalData select @Province, @pCount, @cCount, @ParentSliverCount, @ChildSliverCount

  set @Province = 'KZN'
select @pCount = count(*) from CP2 where Province = @Province
select @cCount = count (b.PIN) from CP2 a inner join ChildCadData b on a.PIN = b.PIN where a.Province = @Province and a.usecode <> b.usecode
  select @ParentSliverCount = count(*) from CP2 where usecode = 'Sliver' and Province = @Province
select @ChildSliverCount = count(*) from ChildCadData where usecode = 'Sliver' and Province = @Province
 insert into @FinalData select @Province, @pCount, @cCount, @ParentSliverCount, @ChildSliverCount


  set @Province = 'LIM'
select @pCount = count(*) from CP2 where Province = @Province
select @cCount = count (b.PIN) from CP2 a inner join ChildCadData b on a.PIN = b.PIN where a.Province = @Province and a.usecode <> b.usecode
 select @ParentSliverCount = count(*) from CP2 where usecode = 'Sliver' and Province = @Province
select @ChildSliverCount = count(*) from ChildCadData where usecode = 'Sliver' and Province = @Province
 insert into @FinalData select @Province, @pCount, @cCount, @ParentSliverCount, @ChildSliverCount


  set @Province = 'MP'
select @pCount = count(*) from CP2 where Province = @Province
select @cCount = count (b.PIN) from CP2 a inner join ChildCadData b on a.PIN = b.PIN where a.Province = @Province and a.usecode <> b.usecode
 select @ParentSliverCount = count(*) from CP2 where usecode = 'Sliver' and Province = @Province
select @ChildSliverCount = count(*) from ChildCadData where usecode = 'Sliver' and Province = @Province
 insert into @FinalData select @Province, @pCount, @cCount, @ParentSliverCount, @ChildSliverCount

  set @Province = 'NC'
select @pCount = count(*) from CP2 where Province = @Province
select @cCount = count (b.PIN) from CP2 a inner join ChildCadData b on a.PIN = b.PIN where a.Province = @Province and a.usecode <> b.usecode
select @ParentSliverCount = count(*) from CP2 where usecode = 'Sliver' and Province = @Province
select @ChildSliverCount = count(*) from ChildCadData where usecode = 'Sliver' and Province = @Province
 insert into @FinalData select @Province, @pCount, @cCount, @ParentSliverCount, @ChildSliverCount

  set @Province = 'NW'
select @pCount = count(*) from CP2 where Province = @Province
select @cCount = count (b.PIN) from CP2 a inner join ChildCadData b on a.PIN = b.PIN where a.Province = @Province and a.usecode <> b.usecode
 select @ParentSliverCount = count(*) from CP2 where usecode = 'Sliver' and Province = @Province
select @ChildSliverCount = count(*) from ChildCadData where usecode = 'Sliver' and Province = @Province
 insert into @FinalData select @Province, @pCount, @cCount, @ParentSliverCount, @ChildSliverCount

  set @Province = 'WC'
select @pCount = count(*) from CP2 where Province = @Province
select @cCount = count (b.PIN) from CP2 a inner join ChildCadData b on a.PIN = b.PIN where a.Province = @Province and a.usecode <> b.usecode
select @ParentSliverCount = count(*) from CP2 where usecode = 'Sliver' and Province = @Province
select @ChildSliverCount = count(*) from ChildCadData where usecode = 'Sliver'  and Province = @Province
 insert into @FinalData select @Province, @pCount, @cCount, @ParentSliverCount, @ChildSliverCount

  select * from @FinalData






select * into LUCData.dbo.CadastralMain from LandUseCapture2.dbo.CadastralMain
select * into LUCData.dbo.CadastralMainArchive from LandUseCapture2.dbo.CadastralMainArchive
select * into LUCData.dbo.CadastralReports from LandUseCapture2.dbo.CadastralReports
select * into LUCData.dbo.CadPIN from LandUseCapture2.dbo.CadPIN
select * into LUCData.dbo.cadPINArchive from LandUseCapture2.dbo.cadPINArchive
select * into LUCData.dbo.NewUseCode from LandUseCapture2.dbo.NewUseCode
select * into LUCData.dbo.Pin_DesktopReviewMain from LandUseCapture2.dbo.Pin_DesktopReviewMain
select * into LUCData.dbo.RejectedBatchDurban from LandUseCapture2.dbo.RejectedBatchDurban

drop table LUCData.dbo.CadastralMain
drop table LUCData.dbo.CadastralMainArchive
drop table LUCData.dbo.CadastralReports
drop table LUCData.dbo.CadPIN
drop table LUCData.dbo.cadPINArchive
drop table LUCData.dbo.NewUseCode
drop table LUCData.dbo.Pin_DesktopReviewMain
drop table LUCData.dbo.RejectedBatchDurban



cast(CaptureStamp as date) = cast(Getdate() as date)




ogr2ogr -f "ESRI Shapefile" "\\10.1.15.15\DropBox\amit\LandUseCaptureData\9Oct2017\PinData.shp" "MSSQL:server=DWJHBGISSVR; database=LUCData;uid=sa;pwd=java" -sql "SELECT ID, Pointgeom.STAsBinary() as geom, Captured, QALevel1, QALevel2, PIN, QAFinal, Category, UseCode, Province, DM, LM from ChildCadData where QAFinal != ''"
ogr2ogr -f "ESRI Shapefile" "\\10.1.15.15\DropBox\amit\LandUseCaptureData\9Oct2017\ParcelDataData8.shp" "MSSQL:server=DWJHBGISSVR; database=LUCData;uid=sa;pwd=java" -sql "SELECT  OID,PIN,Province,LM,DM,Boundary.STAsBinary() as geom,Capturer,QALevel1,QALevel2,QAFinal,Category,UseCode  FROM CadFinalData where BoundarySTR like 'POLYGON%'" -skip-failures





################Duplicate PIN DELETE################

select CONVERT(varchar(50), UID) + ',', * from TblChild2 with(nolock) where PointGeom.STAsText() in ('POINT (17.884918006949263 -29.709268221857993)',
'POINT (17.885925250734843 -29.59858782469329)',
'POINT (30.778221680985808 -29.30989600540051)')
order by PIN

select * from TblChild2

select '$' + pt + '#' from (select pt, count(UID) as cnt from (select PointGeom.STAsText() as pt, UID from TblChild2 with(nolock)) as df group by pt) as de where cnt > 2



delete from TblChild2
where UID in
(24,
56,
242218)




----Mining on OLD Data------
DECLARE @g geometry;  
SET @g = geometry::STGeomFromText('POINT (20.129246  -33.752651)', 4326);  
--SELECT @g.STBuffer(0.01)  
select * from FarmPortionMaster where ogr_geometry.STIntersects(@g.STBuffer(0.1)) = 1
-----------------------------------



select BatchNumber, PIN, CapturedUse,  CapturedBy, CaptureStamp, CaptureRemarks,  Status, QARemarks, QAStamp, QAStatus, QAUse, QABy
into YYY.dbo.CadastralMain
from CadastralMain where BatchNumber in (select BatchNumber from YYY.dbo.DT)

select PIN, PointGeom.STAsText() as PointGeomWKT, UseCodeCaptured, UseCodeQA 
into YYY.dbo.CadPIN from CadPIN
where PIN in (select PIN from  CadastralMain where BatchNumber in (select BatchNumber from YYY.dbo.DT))

select DwCapturer, CaptureStatus, DwQA, QAStatus, BatchNumber, PIN
into YYY.dbo.Pin_DesktopReviewMain from Pin_DesktopReviewMain 
where Pin in (select PIN from  CadastralMain where BatchNumber in (select BatchNumber from YYY.dbo.DT))


declare @FinalData table(PIN int , id int identity(1,1))
insert into @FinalData select PIN from CadSync where IsSync = 0 and BatchNumber = 2017247864 

DECLARE @sP INT;
DECLARE @tP INT;
SET @sP = 1;
SET @tP = 132757;
select @tP = max(id) from @FinalData
WHILE @sP <= @tP
BEGIN
	DECLARE @tPIN INT;
	select @tPIN = PIN from @FinalData where id = @sP
	print @tPIN
	
	update CadastralMain 
	set CapturedUse = p.CapturedUse, CapturedBy= p.CapturedBy, CaptureStamp=p.CaptureStamp, CaptureRemarks = '', Status=p.Status, BatchNumber= p.BatchNumber, QAUse=p.QAUse, QABy=p.QABy, QAStamp=p.QAStamp, QARemarks=p.QARemarks, QAStatus=p.QAStatus
	from CadastralMain a inner join YYY.dbo.CadastralMain p on a.PIN = p.PIN where a.PIN = @tPIN
	
	
	insert Pin_DesktopReviewMain(PIN, DwCapturer, CaptureStatus, DwQA, QAStatus, BatchNumber) select PIN, DwCapturer, CaptureStatus, DwQA, QAStatus, BatchNumber from YYY.dbo.Pin_DesktopReviewMain with (nolock) where PIN = @tPIN
	
	INSERT INTO CadPIN(PIN, PointGeom, UseCodeCaptured, UseCodeQA) select PIN, (geometry::STGeomFromText(PointGeomWKT, 4326)), UseCodeCaptured, UseCodeQA from YYY.dbo.CadPIN with (nolock) where PIN = @tPIN
	
	update CadSync set IsSync = 1, SyncDate = GetDate() where Pin = @tPIN
	
	set @sP = @sP + 1;
END





select distinct batchNumber from CadastralMain 
where  cast(QAStamp1 as date) = cast(Getdate() as date) 






drop table YYY.dbo.DB17112017
select * into YYY.dbo.DB17112017 from (select  count(Pin) as TotalPINCnt, BatchNumber, count(CaptureStatus) as CompleteCnt, count(DwQA1) as QAAssigned  from Pin_DesktopReviewMain with (nolock) group by BatchNumber) as a order by QAAssigned


select * from YYY.dbo.DB17112017 where QAAssigned = 0

ALTER TABLE YYY.dbo.DB17112017 ADD NeedToQADurban int

declare @BTTable table(BT int, id int identity(1,1)) 
insert into @BTTable select BatchNumber from YYY.dbo.DB17112017 where QAAssigned = 0
declare @BT nvarchar(50)  
DECLARE @sP INT;
DECLARE @tP INT;
SET @sP = 1;
select @tP = count(id) from @BTTable
--select @tP
WHILE @sP <= @tP
BEGIN
select @BT = BT from @BTTable where id = @sP


declare @NotQAED int
declare @QAED int
declare @Fin int
select @NotQAED = count(QAStatus)  from LandUseCapture2.dbo.CadastralMain with (nolock) where BatchNumber =  @BT and QAStatus = '';
select @QAED = count(QAStatus) from LandUseCapture2.dbo.CadastralMain with (nolock) where BatchNumber =  @BT and QAStatus != ''
--select @BT, @NotQAED, (@QAED * 10) / 100

Print @BT
set @Fin = @NotQAED;
if(@QAED != 0)
	set @Fin = @NotQAED + ((@QAED * 10) / 100)
	

print @NotQAED + ((@QAED * 10) / 100)
update YYY.dbo.DB17112017 set NeedToQADurban = @Fin where BatchNumber = @BT
set @sP = @sP + 1
END

delete @BTTable

select BatchNumber, TotalPINCnt, NeedToQADurban from YYY.dbo.DB17112017 where QAAssigned = 0



#######################Batch Number needs to be carefull##############
2017248600
#######################################################


####Synce 2nd Round######
declare @BatchNumber bigint
set @BatchNumber = 2017473031

delete from Pin_DesktopReviewMain where BatchNumber = @BatchNumber
--delete from CadPIN where PIN in (select PIN from CadastralMain where BatchNumber = @BatchNumber)
delete from cadsync where BatchNumber = @BatchNumber
update CadastralMain set QAStatus1 = '' 	where BatchNumber = @BatchNumber
--select * from Pin_DesktopReviewMain where BatchNumber = @BatchNumber
--select * from CadPIN where PIN in (select PIN from CadastralMain where BatchNumber = @BatchNumber)
--select * from cadsync where BatchNumber = @BatchNumber

select * from heman where [Batch Number] = 2017473031


select distinct BatchNumber from RejectedBatchDurban where BatchNumber in (
select BatchNumber from (select *, ((QADone * 100) / QAAssigned) as Percentage from (select * from (select  count(Pin) as TotalPINCnt, 
BatchNumber, count(CaptureStatus) as CompleteCnt, count(DwQA) as QAAssigned, count(QAStatus) as QADone from Pin_DesktopReviewMain with (nolock) group by 
BatchNumber) as z where QADone != 0) as a) as f
)
##################################################



2017113097
2017135724
2017192387
2017124866
2017211759
2017464348

2017208238


2017223558
2017551723
2017282292
2017366505
2017247864

################Making Pass################
select * from CadastralMain where BatchNumber = 2017619926 order by QAStamp1 desc

Completed

 AND (QAStatus1 = 'Rejected')

 PIN, CapturedUse, QAUse, QAUse1, QAStatus1, CapturedBy, CaptureStamp, Status, BatchNumber, QAStamp, QAStatus, QABy1, QAStamp1

 SELECT top 100  PIN into ATTT
FROM            CadastralMain
WHERE        (BatchNumber = 2017445277) AND (QAStatus1 = 'Rejected') and (QAUse = '')

select * from ATTT

select PIN, CapturedUse, QAUse, QAUse1, QAStatus1 from CadastralMain where pin in(select PIN from ATTT)

update CadastralMain
set CapturedUse = QAUse1, QAStatus1 = 'Completed'
where  pin in(select PIN from ATTT)
drop table ATTT




select * from CadastralMain where [batchnumber] = 2017576418 
--and  cast(QAStamp1 as date) < cast(Getdate() -4 as date) 
order by QAStamp1 desc

update CadastralMain 
set QAStatus1 = ''
where [batchnumber] = 2017135724 
and  cast(QAStamp1 as date) < cast(Getdate() as date) 



#####################




select * into BTTable from RejectedBatchDurban where BatchNumber in (
select BatchNumber from (select *, ((QADone * 100) / QAAssigned) as Percentage from (select * from (select  count(Pin) as TotalPINCnt, 
BatchNumber, count(CaptureStatus) as CompleteCnt, count(DwQA) as QAAssigned, count(QAStatus) as QADone from LandUseCapture2.dbo.Pin_DesktopReviewMain with (nolock) group by 
BatchNumber) as z where QADone != 0) as a) as f
) 
select * from BTTable where Batchnumber = 2017187711

drop table BTTable


declare @BatchNumber bigint
set @BatchNumber = 2017187711

delete from LandUseCapture2.dbo.Pin_DesktopReviewMain where BatchNumber = @BatchNumber
--delete from CadPIN where PIN in (select PIN from CadastralMain where BatchNumber = @BatchNumber)
delete from LandUseCapture2.dbo.cadsync where BatchNumber = @BatchNumber
update LandUseCapture2.dbo.CadastralMain set QAStatus1 = '' where BatchNumber = @BatchNumber
delete from RejectedBatchDurban where [batchnumber] =@BatchNumber

insert CadSync(PIN, IsSync, BatchNumber) select PIN, 0 , BatchNumber from ANIICC.dbo.CadMain where BatchNumber = @BatchNumber

INSERT INTO LandUseCapture2.dbo.CadPIN(PIN, PointGeom, UseCodeCaptured, UseCodeQA) select PIN, PointGeom, UseCodeCaptured, UseCodeQA 
from ANIICC.dbo.CadPIN where pin in (select PIN from LandUseCapture2.dbo.CadastralMain where BatchNumber = @BatchNumber)

insert LandUseCapture2.dbo.Pin_DesktopReviewMain(PIN, DwCapturer, CaptureStatus, DwQA, QAStatus, BatchNumber) 
select PIN, DwCapturer, CaptureStatus, DwQA, QAStatus, BatchNumber from ANIICC.dbo.Pin_DesktopReviewMain where BatchNumber = @BatchNumber

update LandUseCapture2.dbo.CadastralMain

set [CapturedUse] = b.CapturedUse
      ,[CapturedBy] = b.CapturedBy
      ,[CaptureStamp] = b.CaptureStamp
      ,[CaptureRemarks] = b.CaptureRemarks
      ,[Status] = b.Status
      ,[BatchNumber] = b.BatchNumber
      ,[QAUse] = b.QAUse
      ,[QABy] = b.QABy
      ,[QAStamp] = b.QAStamp
      ,[QARemarks] = b.QARemarks
      ,[QAStatus] = b.QAStatus
      
      from LandUseCapture2.dbo.CadastralMain a inner join ANIICC.dbo.CadMain b
on a.PIN = b.PIN where a.BatchNumber = @BatchNumber


update CadSync set IsSync = 1, SyncDate = GetDate() where BatchNumber = @BatchNumber


update LandUseCapture2.dbo.Pin_DesktopReviewMain set QAStatus = '' where BatchNumber = @BatchNumber and QAStatus is null


--------------------------On India Server---------
declare @BatchNumber bigint
set @BatchNumber = 2017432284
select * from (select *, ((QADone * 100) / QAAssigned) as Percentage from (select * from (select  count(Pin) as TotalPINCnt, 
BatchNumber, count(CaptureStatus) as CompleteCnt, count(DwQA) as QAAssigned, count(QAStatus) as QADone from Pin_DesktopReviewMain with (nolock) group by BatchNumber) as z 
where QADone != 0) as a) as f
where BatchNumber = @BatchNumber

delete from RejectedBatchDurban where [batchnumber] =@BatchNumber

select distinct batchnumber from RejectedBatchDurban



2017416393
2017211759
2017464121
2017296194
2017530419
2017331585
2017647376
2017241479
2017289530
2017159360
2017669260
2017205482
2017286588
2017119833
2017571058
2017370520
2017499301



select count(QAStatus) as f from CadastralMain with (nolock) where BatchNumber in (select BatchNumber from (select  count(Pin) as TotalPINCnt, BatchNumber, count(CaptureStatus) as CompleteCnt, count(DwQA1) as QAAssigned  from Pin_DesktopReviewMain with (nolock) group by BatchNumber) as a where QAAssigned = 0) and QAStatus = '';
  
  select count(QAStatus) * 0.1 as f from CadastralMain with (nolock) where BatchNumber in (select BatchNumber from (select  count(Pin) as TotalPINCnt, BatchNumber, count(CaptureStatus) as CompleteCnt, count(DwQA1) as QAAssigned  from Pin_DesktopReviewMain with (nolock) group by BatchNumber) as a where QAAssigned = 0) and QAStatus != ''
  
  
  
  
  --Get Overlap geometry
  declare @G geometry
  declare @G1 geometry
  declare @G2 geometry
  declare @G3 geometry
  declare @G4 geometry
  declare @G5 geometry
  declare @G6 geometry
  
  select @G = geom.STBuffer(0.01) from Portions where PID = 2
  select @G1 = geom.STBuffer(0.01) from Portions where PID = 180242
  select @G2 = @G1.STDifference(@G)
  select @G3 = @G.STDifference(@G1)
  select @G4 = @G.STUnion(@G1)
  select @G5 = @G4.STDifference(@G2)
  select @G6 = @G5.STDifference(@G3)
  select @G4 union all
  select @G6
